\chapter{Web\+Socket Adapter ({\ttfamily websocket-\/adapter.\+cpp}) }
\hypertarget{md_doc_2websocket-adapter-explanation}{}\label{md_doc_2websocket-adapter-explanation}\index{WebSocket Adapter ($<$tt$>$websocket-\/adapter.cpp$<$/tt$>$)@{WebSocket Adapter ($<$tt$>$websocket-\/adapter.cpp$<$/tt$>$)}}
\label{md_doc_2websocket-adapter-explanation_autotoc_md64}%
\Hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md64}%
\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md65}{}\doxysection{\texorpdfstring{Overview}{Overview}}\label{md_doc_2websocket-adapter-explanation_autotoc_md65}
This C++ file provides a Web\+Socket client implementation for communication with the {\ttfamily calculation\+\_\+unit} service. It handles establishing authenticated Web\+Socket connections and sending/receiving both text and binary Message\+Pack data.

{\bfseries{Important Considerations\+:}}


\begin{DoxyItemize}
\item {\bfseries{Pure ASIO Implementation\+:}} This implementation uses the ASIO C++ library directly for Web\+Socket communication without requiring additional dependencies like Boost.\+Beast.
\item {\bfseries{Message\+Pack Support\+:}} Binary message support is included for sending Message\+Pack formatted data.
\item {\bfseries{Authentication\+:}} Supports Bearer token authentication as required by the Auth\+Proxy service.
\item {\bfseries{Asynchronous Communication\+:}} Provides callback mechanisms for handling messages and connection status changes.
\item {\bfseries{Web\+Socket Protocol\+:}} Implements RFC6455 Web\+Socket protocol including proper framing, masking, and control frames.
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md66}{}\doxysection{\texorpdfstring{Key Components}{Key Components}}\label{md_doc_2websocket-adapter-explanation_autotoc_md66}
\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md67}{}\doxysubsection{\texorpdfstring{1. {\ttfamily Web\+Socket\+Client} Class}{1. {\ttfamily Web\+Socket\+Client} Class}}\label{md_doc_2websocket-adapter-explanation_autotoc_md67}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{class\ }WebSocketClient\ :\ \textcolor{keyword}{public}\ std::enable\_shared\_from\_this<WebSocketClient>\ \{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ Methods\ and\ properties\ for\ managing\ WebSocket\ connections}}
\DoxyCodeLine{\};}

\end{DoxyCode}


A class that encapsulates Web\+Socket connection management with the following capabilities\+:


\begin{DoxyItemize}
\item {\bfseries{Connection Management\+:}} Establishing, maintaining, and closing Web\+Socket connections.
\item {\bfseries{Authentication\+:}} Setting Bearer token in the Authorization header during connection handshake.
\item {\bfseries{Message Exchange\+:}} Sending text and binary messages, receiving messages asynchronously.
\item {\bfseries{Protocol Handling\+:}} Implementing Web\+Socket framing, masking, and control frame handling.
\item {\bfseries{Event Handling\+:}} Callback mechanisms for received messages and connection status changes.
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md68}{}\doxysubsection{\texorpdfstring{2. Callback Types}{2. Callback Types}}\label{md_doc_2websocket-adapter-explanation_autotoc_md68}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{using\ }MessageCallback\ =\ std::function<void(\textcolor{keyword}{const}\ std::string\&,\ \textcolor{keywordtype}{bool})>;}
\DoxyCodeLine{\textcolor{keyword}{using\ }ConnectionCallback\ =\ std::function<void(\textcolor{keywordtype}{bool})>;}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\ttfamily Message\+Callback}\+: Function type for handling received Web\+Socket messages. The boolean parameter indicates whether the message is binary (true) or text (false).
\item {\ttfamily Connection\+Callback}\+: Function type for handling connection status changes (connected/disconnected).
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md69}{}\doxysubsection{\texorpdfstring{3. {\ttfamily connect\+To\+Calculation\+Unit} Function}{3. {\ttfamily connect\+To\+Calculation\+Unit} Function}}\label{md_doc_2websocket-adapter-explanation_autotoc_md69}

\begin{DoxyCode}{0}
\DoxyCodeLine{std::shared\_ptr<WebSocketClient>\ connectToCalculationUnit(}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{const}\ std::string\&\ baseUrl,\ }
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{const}\ std::string\&\ bearerToken,}
\DoxyCodeLine{\ \ \ \ std::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ std::string\&,\ \textcolor{keywordtype}{bool})>\ messageHandler\ =\ \textcolor{keyword}{nullptr},}
\DoxyCodeLine{\ \ \ \ ConnectionCallback\ connectionHandler\ =\ \textcolor{keyword}{nullptr});}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\bfseries{Purpose}}\+: Creates and establishes a Web\+Socket connection to the calculation unit.
\item {\bfseries{Parameters}}\+:
\begin{DoxyItemize}
\item {\ttfamily base\+Url}\+: Host and port of the calculation unit (e.\+g., "{}localhost\+:8082"{}).
\item {\ttfamily bearer\+Token}\+: Authentication token obtained from Auth\+Proxy.
\item {\ttfamily message\+Handler}\+: Optional callback for handling incoming messages.
\item {\ttfamily connection\+Handler}\+: Optional callback for connection status updates.
\end{DoxyItemize}
\item {\bfseries{Returns}}\+: A shared pointer to the Web\+Socket\+Client if successful, nullptr otherwise.
\item {\bfseries{Implementation}}\+:
\begin{DoxyItemize}
\item Parses the base\+Url to extract host and port.
\item Creates a Web\+Socket client instance with the appropriate parameters.
\item Sets up message and connection handlers if provided.
\item Connects to the server and starts the IO context in a separate thread.
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md70}{}\doxysubsection{\texorpdfstring{4. {\ttfamily send\+Message\+Pack\+To\+Calculation\+Unit} Function}{4. {\ttfamily send\+Message\+Pack\+To\+Calculation\+Unit} Function}}\label{md_doc_2websocket-adapter-explanation_autotoc_md70}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{bool}\ sendMessagePackToCalculationUnit(}
\DoxyCodeLine{\ \ \ \ std::shared\_ptr<WebSocketClient>\ client,}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{const}\ std::vector<uint8\_t>\&\ messagePackData);}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\bfseries{Purpose}}\+: Sends Message\+Pack formatted data to the calculation unit.
\item {\bfseries{Parameters}}\+:
\begin{DoxyItemize}
\item {\ttfamily client}\+: The Web\+Socket\+Client connected to the calculation unit.
\item {\ttfamily message\+Pack\+Data}\+: Message\+Pack formatted data as a vector of bytes.
\end{DoxyItemize}
\item {\bfseries{Returns}}\+: True if the message was sent successfully, false otherwise.
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md71}{}\doxysubsection{\texorpdfstring{5. {\ttfamily close\+Calculation\+Unit\+Connection} Function}{5. {\ttfamily close\+Calculation\+Unit\+Connection} Function}}\label{md_doc_2websocket-adapter-explanation_autotoc_md71}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ closeCalculationUnitConnection(std::shared\_ptr<WebSocketClient>\ client);}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\bfseries{Purpose}}\+: Gracefully closes the Web\+Socket connection to the calculation unit.
\item {\bfseries{Parameters}}\+:
\begin{DoxyItemize}
\item {\ttfamily client}\+: The Web\+Socket\+Client to close.
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md72}{}\doxysection{\texorpdfstring{Web\+Socket Protocol Implementation}{Web\+Socket Protocol Implementation}}\label{md_doc_2websocket-adapter-explanation_autotoc_md72}
The adapter implements the Web\+Socket protocol according to RFC6455, including\+:


\begin{DoxyEnumerate}
\item {\bfseries{Handshake}}\+: The initial HTTP-\/based handshake with the server, including Authentication headers.
\item {\bfseries{Framing}}\+: Proper framing of outgoing messages with FIN bit, opcode, masking, and payload.
\item {\bfseries{Control Frames}}\+: Handling of Web\+Socket control frames\+:
\begin{DoxyItemize}
\item {\bfseries{Close (0x8)}}\+: For connection termination
\item {\bfseries{Ping (0x9)}}\+: Automatically responds with Pong frames
\item {\bfseries{Pong (0xA)}}\+: Processes incoming Pong frames
\end{DoxyItemize}
\item {\bfseries{Masking}}\+: Client-\/side masking of data as required by the protocol.
\item {\bfseries{Binary Data}}\+: Support for both text and binary messages (opcode 0x1 and 0x2, respectively).
\end{DoxyEnumerate}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md73}{}\doxysection{\texorpdfstring{Connection Flow}{Connection Flow}}\label{md_doc_2websocket-adapter-explanation_autotoc_md73}
The connection flow with the Web\+Socket adapter follows these steps\+:


\begin{DoxyEnumerate}
\item {\bfseries{Authentication with Auth\+Proxy}}\+: The client first authenticates with the Auth\+Proxy service using the HTTP adapter and obtains a Bearer token.
\item {\bfseries{Web\+Socket Connection}}\+: The client then establishes a Web\+Socket connection to the calculation unit using the Bearer token\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{auto}\ wsClient\ =\ connectToCalculationUnit(}
\DoxyCodeLine{\ \ \ \ \textcolor{stringliteral}{"{}localhost:8082"{}},\ \ \ \ \ \ \textcolor{comment}{//\ Calculation\ unit\ address}}
\DoxyCodeLine{\ \ \ \ bearerToken,\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Token\ from\ authentication}}
\DoxyCodeLine{\ \ \ \ [](\textcolor{keyword}{const}\ std::string\&\ msg,\ \textcolor{keywordtype}{bool}\ isBinary)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{comment}{//\ Handle\ incoming\ messages}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ [](\textcolor{keywordtype}{bool}\ connected)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{comment}{//\ Handle\ connection\ status\ changes}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{);}

\end{DoxyCode}

\item {\bfseries{Message Exchange}}\+: Once connected, the client can send Message\+Pack formatted data\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{std::vector<uint8\_t>\ msgpackData\ =\ \textcolor{comment}{/*\ MessagePack\ formatted\ data\ */};}
\DoxyCodeLine{sendMessagePackToCalculationUnit(wsClient,\ msgpackData);}

\end{DoxyCode}

\item {\bfseries{Connection Termination}}\+: When done, the client can close the connection\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{closeCalculationUnitConnection(wsClient);}

\end{DoxyCode}

\end{DoxyEnumerate}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md74}{}\doxysection{\texorpdfstring{Dependencies}{Dependencies}}\label{md_doc_2websocket-adapter-explanation_autotoc_md74}

\begin{DoxyItemize}
\item {\bfseries{ASIO C++ Library}}\+: For networking functionality (already included in the project).
\item {\bfseries{Standard C++ Libraries}}\+: string, iostream, memory, functional, vector, thread.
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md75}{}\doxysection{\texorpdfstring{Error Handling}{Error Handling}}\label{md_doc_2websocket-adapter-explanation_autotoc_md75}

\begin{DoxyItemize}
\item The Web\+Socket adapter includes comprehensive error handling for connection failures, read/write errors, and disconnection events.
\item All errors are logged to stderr with descriptive messages.
\item Connection callbacks are triggered appropriately to notify the application of status changes.
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md76}{}\doxysection{\texorpdfstring{Thread Safety}{Thread Safety}}\label{md_doc_2websocket-adapter-explanation_autotoc_md76}

\begin{DoxyItemize}
\item The Web\+Socket communication occurs in a separate thread managed by ASIO\textquotesingle{}s io\+\_\+context.
\item Callbacks are invoked from this thread, so appropriate synchronization may be needed when interacting with \doxylink{class_u_i}{UI} components.
\end{DoxyItemize}\hypertarget{md_doc_2websocket-adapter-explanation_autotoc_md77}{}\doxysection{\texorpdfstring{Usage Example}{Usage Example}}\label{md_doc_2websocket-adapter-explanation_autotoc_md77}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{//\ Example\ workflow:}}
\DoxyCodeLine{\textcolor{comment}{//\ 1.\ First\ authenticate\ using\ the\ HTTP\ adapter}}
\DoxyCodeLine{\textcolor{keyword}{auto}\ authResponse\ =\ authenticateUser(baseUrl,\ username,\ password);}
\DoxyCodeLine{std::string\ bearerToken\ =\ authResponse.authorizationHeader;}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ 2.\ Create\ a\ lobby\ (if\ needed)}}
\DoxyCodeLine{\textcolor{keyword}{auto}\ lobbyResponse\ =\ createLobby(baseUrl,\ lobbyName,\ bearerToken);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ 3.\ Connect\ to\ the\ calculation\ unit}}
\DoxyCodeLine{\textcolor{keyword}{auto}\ wsClient\ =\ connectToCalculationUnit(}
\DoxyCodeLine{\ \ \ \ \textcolor{stringliteral}{"{}localhost:8082"{}},\ }
\DoxyCodeLine{\ \ \ \ bearerToken,}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ Message\ handler}}
\DoxyCodeLine{\ \ \ \ [](\textcolor{keyword}{const}\ std::string\&\ message,\ \textcolor{keywordtype}{bool}\ isBinary)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isBinary)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Received\ binary\ MessagePack\ data"{}}\ <<\ std::endl;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Handle\ MessagePack\ binary\ data}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Received\ text:\ "{}}\ <<\ message\ <<\ std::endl;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ Connection\ handler}}
\DoxyCodeLine{\ \ \ \ [](\textcolor{keywordtype}{bool}\ connected)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (connected)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Connected\ to\ calculation\ unit"{}}\ <<\ std::endl;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ std::cout\ <<\ \textcolor{stringliteral}{"{}Disconnected\ from\ calculation\ unit"{}}\ <<\ std::endl;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ 4.\ Send\ MessagePack\ formatted\ data}}
\DoxyCodeLine{std::vector<uint8\_t>\ messagePackData\ =\ \{\textcolor{comment}{/*\ MessagePack\ data\ */}\};}
\DoxyCodeLine{sendMessagePackToCalculationUnit(wsClient,\ messagePackData);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ 5.\ Later,\ when\ done\ with\ the\ connection}}
\DoxyCodeLine{closeCalculationUnitConnection(wsClient);}

\end{DoxyCode}
 